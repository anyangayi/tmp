# OSPF学习笔记1

## OSPF区域

### 意义
- 反映层次结构
- 减少SPF的计算量，减少路由流量
- 降低对CPU、内存资源的消耗
- 使网络拓扑结构与路由协议之间建立对应关系
- 可以在不同区域施行不同的路由策略，使组网规划更为灵活方便

### 骨干区域(Backbone Area)
- OSPF的特殊区域，区域号0.0.0.0
- 负责发布其他区域之间的路由信息
- 始终包含所有的ABR
- 必须是连续的，虽然不一定是物理上连续
- 骨干区域的连续性可以通过配置虚拟通道(virtual link)来建立和维持

### 虚拟通道(virtual link)
- 虚拟通道可以在任何两台拥有同一非骨干区域接口的骨干路由器(ABR)之间建立
- 虚拟通道属于骨干区域
- 协议将通过虚拟通道所连接的两台路由器，视为通过骨干区域内的无编号点对点网络连接
- 虚拟通道是为了恢复/增强骨干区域的连通性
- 配置参数：虚拟通道另一端的路由器标识和虚拟通道使用的非骨干区域号

### 传输区域(Transit Area)
- 能够传输既不是由本区域产生，也不是到达本区域的数据流量(Summary-LSA和AS-external-LSA)的区域
- 被用来连接骨干网
- 在区域数据结构中用TransitCapability表示

### 存根区域(stub Area)
- AS-external-LSA不被洪泛进该区域
- 减少了该区域内部路由器中链路状态数据库的大小，以及所需要的内存
- 在存根区域内必须使用默认路径，通过Summary-LSA宣告
- 当一个区域内只有单一出口，或者不需要按每条外部路径来选择离开区域的出口时，可以将其配置为存根区域
- 限制：在存根区域中不能配置有虚拟通道，也不能存在ASBR
- 配置参数：ExternalRoutingCapability、StubDefaultCost

### NSSA区域
- NSSA区域是Stub区域概念的延伸，保留了部分stub区域的特征
- NSSA区域允许少量外部路由(Type 7：NSSA External LSA)通过本区域的ASBR通告进来
- 当需要将外部路由洪泛进骨干区域，则要在ABR将7类LSA转为5类LSA

### 路由器分类
- 内部路由器(IR)：路由器所直接连接的网络都属于同一个区域，这些路由器只运行路由算法的一个副本
- 区域边界路由器(ABR)：接入多个区域的路由器，运行路由算法的多个副本，每个接入的区域一个
- 骨干路由器(Backbone Routers)：有至少一个接口在骨干区域的路由器，包括所有接入多个区域的路由器(即ABR)
- 自治系统边界路由器(ASBR)：与属于其他AS的路由器交换路由信息的路由器，在AS内宣告AS外部路由信息
- - -

## 路由计算

### 区域内路由
- 路由器启动时，首先初始化路由协议的数据结构，然后等待下层协议提示接口可以开始工作
- 然后路由器使用OSPF的Hello协议来探知邻居：路由器向其邻居发送Hello包，并等待接收邻居发送的Hello包
- 路由器试图与新探知的邻居建立邻接(adjacencies)关系，在邻接路由器之间链路状态数据库是同步的
- 路由器周期性的宣告其状态(LSA)，即连接状态；在路由器状态改变时也会宣告连接状态
- LSA在整个区域中被洪泛，以确保区域中所有的路由器拥有完全相同的链路状态数据库
- 从这个数据库，每台路由器构建出以自己为树根的最短路径树，再由最短路径树计算出协议的路由表

### 区域间路由
- 当数据包在两个非骨干区域之间转发时，使用骨干区域
- 数据包所经过的路径可以被分为三段连续的过程
  - 从源到ABR的区域内路径
  - 从源区域到目标区域的骨干路径
  - 到达目标的另一个区域内路径
- 换一个角度看，区域间路由可以被理解为一个星形配置的AS，骨干区域是中心，每个非骨干区域是分支。
- 选择恰当的ABR作为离开源区域出口的方法，与选择宣告外部路径的路由器的方法完全相同
  - 区域内的每个ABR计算到达区域外所有网络的距离
  - 区域内路由器在计算了最短路径树以后，到达外部目标的距离值等于上述数值加上到达ABR所需的距离

### 自治系统外部路由
- ASBR将其他AS的信息洪泛进整个AS中，这些外部路由信息被逐个发布到每台参与的路由器
- 整个AS(除了存根区域内)中的路由器，都需要知道到达ASBR的路径
- 外部路由信息可以是由其他诸如BGP的路由协议所产生，或是被静态配置(静态路由)
- OSPF支持两种类型的外部距离
  - 类型1被解释为与OSPF接口值(也就是连接状态中的距离值)使用同样的计量单位
  - 类型2使用在更大层次上，类型2的距离被认为大于任何AS内部的路径距离

### 等值多路径
- 当有多条等值路径到达同一目标时，这些路径都会被发现并使用
- 当存在等值多路径时，路由器会有到达指定目标的多个可用下一跳。
- - -

## 报头结构

### IP报头
- OSPF直接运行在网络层之上
- OSPF的IP协议号为89
- OSPF协议包比普通IP数据包优先级高
- 使用IP多播，两个多播地址：
  - AllSPFRouters：224.0.0.5，Hello包始终发往该目标，所有运行OSPF的路由器必须准备接收发送到该地址的包
  - AllDRouters：224.0.0.6，DR和BDR必须准备接收发送到该地址的包

### OSPF标准报头
- 版本号(Version)：本规范所说明的协议版本号为2
- 类型(Type)：
  - Hello包
  - 数据库描述包(DD)
  - 连接状态请求包(LSR)
  - 连接状态更新包(LSU)
  - 连接状态确认包(LSAck)
- 包长度(Packet length)：整个OSPF包的字节长度，包括标准的OSPF头部
- 路由器标识(Router ID)：生成包的路由器标识
- 区域标识(Area ID)：一个32位数，表示包所属于的区域
- 校验和(Checksum)：从OSPF包头开始，整个包的标准IP校验和
- 验证类型(AuType)：说明所使用验证过程的类型
  - 0：空验证，在网络/子网上的路由交换没有被验证
  - 1：简单口令验证，使用验证域包含64位的明文密码，避免路由器错误的加入路由域
  - 2：密码验证：使用验证域包含一个共享的密码，该密码用于生成/检验加在OSPF包最后的信息摘要
  - 其他：保留
- 验证域(Authentication)：64位的验证域被所选择的验证类型所使用

### Hello报头字段
- 网络掩码(Network mask)：该接口所关联的网络掩码
- HelloInterval：路由器发送Hello包的间隔秒数(缺省为10s)
- 选项(Options)：
  - E：允许洪泛AS-External-LSAs
  - MC：转发IP组播报文
  - N/P：处理Type-7 LSAs
  - DC：处理按需链路
- 路由器优先级(Rtr Pri)：用于DR、BDR的选举，如果设为0路由器就不能成为DR或BDR
- RouterDeadInterval：在宣告安静的路由器为断开前所需要等待的秒数(缺省为4*HelloInterval)
- 指定路由器(Designated Router)：以发送路由器的视角认为网络上的DR
- 备份指定路由器(Backup Designated Router)：以发送路由器的视角认为网络上的BDR
- 邻居(Neighbor)：通过有效的Hello包，从网络上新近收到的路由器标识
- (在同一网段上的路由器，其HelloInterval和RouterDeadInterval必须分别一致，否则不能形成邻居关系)
- - -

## 接口状态和邻居状态

### 接口状态
- Down：接口的初始状态，这时下层协议指出接口为断开，接口上没有协议流量的收发
- Loopback：路由器到网络的接口处于回环状态，回环接口不能用于正常的数据传输，但仍能通过ICMP ping或位错误检测来收集接口信息，回环可能以硬件或软件的方式实现
- Waiting：在此状态时，路由器试图判定网络上DR和BDR，即对其接收到的Hello包进行监听
- Point-to-point：连接到物理点对点网络或虚拟通道的接口开始工作，进入此状态之后，路由器试图与邻居路由器形成邻接，并按HelloInterval的间隔发送Hello包
- DR Other：广播或NBMA网络上的其他路由器被选举为DR，其自身也没有被选为BDR，路由器开始与DR和BDR（如果存在的话）形成邻接
- Backup：在此状态时，路由器是所接入网络的BDR，并将在当前的DR失效时成为DR
- DR：在此状态时，路由器是所接入网络的DR，该路由器与接入该网络的所有其他路由器形成邻接
- (DR与BDR的选举以Hello报头中的路由器优先级字段为准，当优先级字段相等时比较路由器标识，路由器标识大的被选举)

### 邻居状态
- Down：邻居状态转换的初始状态，表示最近没有从邻居收到信息
- Attempt：该状态仅对NBMA网络上的邻居有效，表示最近没有从邻居收到信息，但仍需作出进一步的尝试，用以与邻居联系
- Init：在此状态时，表示收到了由邻居发送的Hello包，但还没有建立与邻居的双向通讯
- 2-Way：在此状态时，两台路由器的通讯达到双向，这是通过Hello协议而实现的
- ExStart：这是两台邻居路由器之间建立邻接的第一步，此步的目标是确定路由器的主从并确定初始的DD序号，达到此状态或更高状态的邻居会话被称为邻接
- Exchange：在此状态的路由器通过向邻居发送DD包，来描述其完整的链路状态数据库
- Loading：在此状态下，进行数据库的同步，向邻居发送LSR包来取得较新的LSA
- Full：在此状态下，邻居路由器达到完全邻接，现在开始这些邻接将出现在Router-LSA和Network-LSA中
- (其中Down、2-Way和Full状态为稳态，其余状态为暂态)

### 是否形成邻接
- 当满足下列至少一个条件时，在双向邻居间建立邻接：
- 下层网络的类型为点对点
- 下层网络的类型为点对多点
- 下层网络的类型为虚拟通道
- 路由器自身为指定路由器
- 路由器自身为备份指定路由器
- 邻居路由器为指定路由器
- 邻居路由器为备份指定路由器

### 邻居状态转移
- Down->Init：收到邻居的Hello，且Hello包中不包含自身
- Init->2-Way：收到邻居的Hello，且Hello包中包含自身，即形成双向通讯
- 2-Way->Exstart：需要建立邻接
- ExStart->Exchange：通过DD包确认了主从关系
- Exchange->Loading：接收包含LSA的DD包，发现新LSA时记录于请求列表中，并开始收发LSR、LSU和LSAck包以进行同步；当接收到全部DD包后变更状态
- Exchange->Full：当接收到全部DD包且请求列表为空时变更状态
- Loading->Full：双方收发LSR、LSU和LSAck包，同步结束变更状态
- ExStart或更高->2-Way：不再需要继续与邻居建立邻接
- Exchange或更高->ExStart：发生SeqNumberMismatch或BadLSReq事件时进行状态回退，邻接被拆除并尝试重新建立
- 任意状态->Down：发生KillNbr、LLDown和InactivatyTimer事件时直接将状态回退到Down
- - -

## DD包和同步

### DD包
- 同步过程在路由器之间试图形成邻接时开始
- 每台路由器通过向其邻居发送一系列DD包，来描述自身的数据库，每个DD包中包含了路由器数据库中的一组LSA，当邻居发现其中的LSA比自己数据库中的要新时，就记录下需要请求的LSA
- 这种发送和接收DD包的过程被称为"数据库交换过程"，在这个过程中两台路由器形成主从关系
- 每个DD包都通过一个标识M(更多)位，来表示后面是否还有更多的包，当路由器收到并发出清除了M位的DD包后表示数据库交换过程结束
- 报头字段：
  - 接口MTU(Interface MTU)：从所关联的接口不分片而能发送的最大IP包字节大小
  - 选项(Options)：路由器所支持的选项，同Hello报头
  - I位：初始位，在第一个DD包中设定为1
  - M位：更多位，当后面还有更多的DD包时设定为1
  - MS位：主从位，在数据库交换过程中的主机设定为1，否则该路由器为从机
  - DD序号：用于描述DD包的序号，其初始值应当唯一
  - 一个LSA头部

### DD包收发——主从协商阶段
- 当两个邻居交换数据库时，形成主从关系，主从关系在ExStart状态下协商
- 主机发送第一个DD包，并且只能由其重发，从机仅能响应主机的DD包
- DD包的发送取决于邻居的状态：在ExStart状态时，路由器发送设定了初始I、M、MS位的空包
- DD包的接收取决于邻居的状态：
  - Down：包应当被拒绝
  - Attempt：包应当被拒绝
  - Init：邻居状态机应当执行事件2-Way Received，这导致立即变为状态2-Way或状态ExStart
  - 2-Way：包应当被忽略
  - ExStart：包应当被接收，设定主从关系后将状态变为Exchange
- 设定主从关系时，设备A发出(I==1,M==1,MS==1,DD序号==x)的DD包：
  - 若设备B同意成为从机，则返回(I==0,M==1,MS==0,DD序号==x)的DD包
  - 若设备B认为自己才应该是主机，则返回(I==1,M==1,MS==1,DD序号==y)的DD包
  - 主从机的协商以路由器标识为准，路由器标识大的为主机

### DD包收发——LSA的信息交换
- 在Exchange状态中的DD包，实际上包含了路由器数据库中连接状态信息的摘要
- 在Exchange状态下DD包的发送取决于路由器的主从状态：
  - 主机：在下列两个条件之一时，发送DD包：
    - 从机通过回显DD序号，确认了前一个DD包
    - 经过了RxmtInterval秒也没有收到确认，这时重传前一个DD包
  - 从机：只能在接收到由主机发送的DD包时，才能发送DD包作为回应

### DD包收发——LSA交换完成后的处理
- 在Loading和Full状态下，当收到主机重复的DD包时，从机必须重新发送最后一个DD包来作出回应
- 在Loading和Full状态下，路由器已经收发了全部DD包，只可能接收重复的DD包
- - -

## 图例

### AS示意图
                 +
                 | 3+---+                     N12      N14
               N1|--|RT1|\ 1                    \ N13 /
                 |  +---+ \                     8\ |8/8
                 +         \ ____                 \|/
                            /    \   1+---+8    8+---+6
                           *  N3  *---|RT4|------|RT5|--------+
                            \____/    +---+      +---+        |
                  +         /   |                  |7         |
                  | 3+---+ /    |                  |          |
                N2|--|RT2|/1    |1                 |6         |
                  |  +---+    +---+8            6+---+        |
                  +           |RT3|--------------|RT6|        |
                              +---+              +---+        |
                                |2               Ia|7         |
                                |                  |          |
                           +---------+             |          |
                               N4                  |          |
                                                   |          |
                       N11                         |          |
                   +---------+                     |          |
                        |                          |          |    N12
                        |3                         |          |6 2/
                      +---+                        |        +---+/
                      |RT9|                        |        |RT7|---N15
                      +---+                        |        +---+ 9
                        |1                   +     |          |1
                       _|__                  |   Ib|5       __|_
                      /    \      1+----+2   |  3+----+1   /    \
                     *  N9  *------|RT11|----|---|RT10|---*  N6  *
                      \____/       +----+    |   +----+    \____/
                        |                    |                |
                        |1                   +                |1
             +--+   10+----+                N8              +---+
             |H1|-----|RT12|                                |RT8|
             +--+SLIP +----+                                +---+
                        |2                                    |4
                        |                                     |
                   +---------+                            +--------+
                       N10                                    N7

### 对应的连接图
                                **FROM**
                 |RT|RT|RT|RT|RT|RT|RT|RT|RT|RT|RT|RT|
                 |1 |2 |3 |4 |5	|6 |7 |8 |9 |10|11|12|N3|N6|N8|N9|
              ----- ---------------------------------------------
              RT1|  |  |  |  |  |  |  |  |  |  |  |  |0 |  |  |  |
              RT2|  |  |  |  |  |  |  |  |  |  |  |  |0 |  |  |  |
              RT3|  |  |  |  |  |6 |  |  |  |  |  |  |0 |  |  |  |
              RT4|  |  |  |  |8 |  |  |  |  |  |  |  |0 |  |  |  |
              RT5|  |  |  |8 |  |6 |6 |  |  |  |  |  |  |  |  |  |
              RT6|  |  |8 |  |7 |  |  |  |  |5 |  |  |  |  |  |  |
              RT7|  |  |  |  |6 |  |  |  |  |  |  |  |  |0 |  |  |
          *   RT8|  |  |  |  |  |  |  |  |  |  |  |  |  |0 |  |  |
          *   RT9|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |0 |
          T  RT10|  |  |  |  |  |7 |  |  |  |  |  |  |  |0 |0 |  |
          O  RT11|  |  |  |  |  |  |  |  |  |  |  |  |  |  |0 |0 |
          *  RT12|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |0 |
          *    N1|3 |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
               N2|  |3 |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
               N3|1 |1 |1 |1 |  |  |  |  |  |  |  |  |  |  |  |  |
               N4|  |  |2 |  |  |  |  |  |  |  |  |  |  |  |  |  |
               N6|  |  |  |  |  |  |1 |1 |  |1 |  |  |  |  |  |  |
               N7|  |  |  |  |  |  |  |4 |  |  |  |  |  |  |  |  |
               N8|  |  |  |  |  |  |  |  |  |3 |2 |  |  |  |  |  |
               N9|  |  |  |  |  |  |  |  |1 |  |1 |1 |  |  |  |  |
              N10|  |  |  |  |  |  |  |  |  |  |  |2 |  |  |  |  |
              N11|  |  |  |  |  |  |  |  |3 |  |  |  |  |  |  |  |
              N12|  |  |  |  |8 |  |2 |  |  |  |  |  |  |  |  |  |
              N13|  |  |  |  |8 |  |  |  |  |  |  |  |  |  |  |  |
              N14|  |  |  |  |8 |  |  |  |  |  |  |  |  |  |  |  |
              N15|  |  |  |  |  |  |9 |  |  |  |  |  |  |  |  |  |
               H1|  |  |  |  |  |  |  |  |  |  |  |10|  |  |  |  |

### 接口状态转移图
                                  +----+   UnloopInd   +--------+
                                  |Down|<--------------|Loopback|
                                  +----+               +--------+
                                     |
                                     |InterfaceUp
                          +-------+  |               +--------------+
                          |Waiting|<-+-------------->|Point-to-point|
                          +-------+                  +--------------+
                              |
                     WaitTimer|BackupSeen
                              |
                              |
                              |   NeighborChange
          +------+           +-+<---------------- +-------+
          |Backup|<----------|?|----------------->|DROther|
          +------+---------->+-+<-----+           +-------+
                    Neighbor  |       |
                    Change    |       |Neighbor
                              |       |Change
                              |     +--+
                              +---->|DR|
                                    +--+

### 邻居状态转移图
                                   +----+
                                   |Down|
                                   +----+
                                     |\
                                     | \Start
                                     |  \      +-------+
                             Hello   |   +---->|Attempt|
                            Received |         +-------+
                                     |             |
                             +----+<-+             |HelloReceived
                             |Init|<---------------+
                             +----+<--------+
                                |           |
                                |2-Way      |1-Way
                                |Received   |Received
                                |           |
              +-------+         |        +-----+
              |ExStart|<--------+------->|2-Way|
              +-------+                  +-----+

                                  +-------+
                                  |ExStart|
                                  +-------+
                                    |
                     NegotiationDone|
                                    +->+--------+
                                       |Exchange|
                                    +--+--------+
                                    |
                            Exchange|
                              Done  |
                    +----+          |      +-------+
                    |Full|<---------+----->|Loading|
                    +----+<-+              +-------+
                            |  LoadingDone     |
                            +------------------+
- - -
