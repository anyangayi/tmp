# OSPF学习笔记2

## LSA

### LSA标准报头
- LS时限：从LSA生成开始的时间秒数，表示LSA存在的时间
- 选项：所描述的路由域中支持的可选项，同Hello报头
- LS类型：LSA的类型，各种类型的LSA使用不同的格式，LSA类型如下：
  - Router-LSAs：由所有路由器产生，表述路由器在一个区域内所有接口的状态，仅在一个区域内洪泛
  - Network-LSAs：由广播/NBMA网络中的指定路由器产生，包含接入该网络的路由器列表，仅在一个区域内洪泛
  - Net-Summary-LSAs：由ABR产生，描述一条在区域外但在AS内的路径(区域间路径)，在与该LSA关联的区域内洪泛
  - ASBR-Summary-LSA：由ABR产生，描述一条到达区域外ASBR的路径(区域间路径)，在与该LSA关联的区域内洪泛
  - AS-external-LSAs：由ASBR产生，描述另一AS中的一条路径，在整个AS内洪泛(不包含末梢区域)
  - NSSA-External-LSAs：由ASBR产生，描述另一AS中的一条路径，仅在NSSA内洪泛，当需要洪泛进骨干区域，则要在ABR将7类LSA转为5类LSA
- LS标识：描述网络部件，具体的内容取决于LSA中的LS类型
  - LS类型1：生成路由器的路由器标识
  - LS类型2：该网络上DR的IP接口地址
  - LS类型3：目标网络的IP地址
  - LS类型4：所描述的ASBR的路由器标识
  - LS类型5：目标网络的IP地址
  - LS类型7：目标网络的IP地址
- 宣告路由器：生成该LSA的路由器标识，例如Network-LSA中该域等于网络上DR的路由器标识，对于Router-LSA该域与LS标识域相同
- LS序号：用于判定旧的或重复的LSA，连续的LSA实例使用连续的LS序号
- LS校验和：整个LSA的Fletcher校验和，包括除LSA时限域外的LSA头部
- 长度：LSA的字节长度，包含20字节的LSA头部
- (LS类型、LS标识和宣告路由器唯一标识LSA，LS序号、LS校验和LS时限唯一标识LSA的一个实例)
- (为了防止环路，Summary-LSA(区域间路由)必须经过骨干区域进行中转)

### 生成LSA
- 路由器周期性生成的LSA，当LS时限达到LSRefreshTime时，其生成LSA的新实例，这增强了连接状态算法的强壮性
- 当接口状态改变，可能需要生成一个Router-LSA的新实例
- 当所接入网络的DR改变时，生成一个新的Router-LSA，此外如果路由器新成为DR的话，生成一个新的Network-LSA
- 其邻居路由器的状态达到FULL状态或不再是FULL状态，都将导致生成Router-LSA的新实例，此外如果路由器是DR的话，生成一个新的Network-LSA
- 下面的4种事件仅关联ABR
  - 当路由表中的区域内路径改变(增加/删除/修改)时，可能需要向其所接入的区域生成新的Summary-LSA
  - 当路由表中的区域间路径改变时，可能需要向其所接入的区域(不包含骨干区域)生成新的Summary-LSA
  - 当路由器新接入一个区域，路由器必须为该区域生成所有路由表中相关的区域内和区域间路径的Summary-LSA
  - 当路由器上配置的虚拟通道状态改变，可能需要向传输区域生成新的Router-LSA，同时需要向骨干区域生成新的Network-LSA
- 最后的2种事件仅关联ASBR
  - 当直接从其他路由协议(如BGP)获取的外部路径改变时，将导致ASBR生成新的AS-external-LSA
  - 可能因为重新启动而使路由器不再成为ASBR，这将使路由器删除所有其原先生成的AS-external-LSA

### Router-LSA报头字段
- V位：设置时，该路由器是一条或多条完全邻接的虚拟通道的端点，并说明区域为传输区域
- E位：设置时，该路由器为一个ASBR
- B位：设置时，该路由器为一个ABR
- 连接数：该LSA所描述的路由器连接数量，必须是该区域路由器连接(接口)的总和
- 类型：路由器连接的基本描述，可为以下值：
  - 1：点对点连接到另一路由器
  - 2：连接到传输网络
  - 3：连接到存根网络
  - 4：虚拟通道
- 连接标识：表示路由器连接所接入的目标，其值取决于连接的类型：
  - 连接类型1：邻居的路由器标识
  - 连接类型2：DR的IP接口地址
  - 连接类型3：IP网络/子网号
  - 连接类型4：邻居的路由器标识
- 连接数据：其值同样取决于连接的类型：
  - 对于存根网络连接，连接数据说明的是网络的IP地址掩码
  - 对于无编号点对点网络，说明的是接口的MIB-II索引值
  - 对于其他类型的连接，说明的是当前路由器接口的IP地址
- TOS数：该连接不同TOS的数量
- 距离值：路由器连接的距离
- 可能包括附加的TOS信息，用于和以前版本的OSPF兼容

### 生成Router-LSA
- 路由器为其所接入的每个区域生成Router-LSA，描述路由器接入该区域的接口状态，该LSA仅在特定的区域内被洪泛
- 描述点对点接口：
  - 如果邻居路由器为完全邻接，加入类型1连接，连接标识应当被设为邻居路由器标识
  - 只要接口状态为"点对点"，加入类型3连接，有2种情况：
    - 假设已知邻居路由器的IP地址，则连接标识为邻居IP地址，连接数据为掩码0xffffffff(表示主机路径)
    - 如果在点对点连接上设定了子网，则连接标识为子网的IP地址，连接数据为子网掩码
- 描述广播和NBMA接口：
  - 如果接口状态为Waiting，加入类型3连接，连接标识为所接入网络的IP地址，连接数据为所接入网络的网络掩码
  - 否则，所接入网络上会有被选举出的DR，加入类型2连接，连接标识为所接入网络中DR的IP接口地址，连接数据为路由器自己的IP接口地址
- 描述虚拟通道：
  - 仅当虚拟邻居为完全邻接时，加入类型4连接，连接标识为虚拟邻居的路由器标识，连接数据为关联接口的IP接口地址
- 描述点对多点接口：同点对点接口
- 示例：RT3分别为区域1和骨干区域生成2个Router-LSA：
  - 区域1的Router-LSA中包含一个传输网络和一个末梢网络连接
  - 骨干区域的Router-LSA中包含一个无编号点对点连接

### Network-LSA报头字段与生成
- 网络掩码：该网络的IP地址掩码
- 接入路由器：接入该网络的各个路由器的路由器标识，只有与DR达到完全邻接的路由器(包括DR自身)才被列出
- DR为每个传输的广播或NBMA网络生成Network-LSA，描述所有接入网络的路由器，仅在包含该传输网络的区域中洪泛
- 示例：若RT4是传输网络N3的DR，则其生成Network-LSA，包含4个接入路由器(RT1、RT2、RT3和RT4)

### Summary-LSA报头字段与生成
- 网络掩码：对于类型3的Summary-LSA，表示网络的IP地址掩码；对于类型4的Summary-LSA，该域无意义必须设定为0
- 距离值：路径的距离
- 可能包括附加的TOS信息，用于和以前版本的OSPF兼容
- ABR生成，描述一条在区域外但在AS内的路径(区域间路径)，仅在一个区域内洪泛
- 为了防止环路，Summary-LSA必须经过骨干区域进行中转
- 对于存根区域，类型3的Summary-LSA被用于描述默认路径，Summary-LSA的LS标识始终为DefaultDestination(0.0.0.0)，并且其网络掩码被设为0.0.0.0，而没有类型4的Summary-LSA
- 示例：RT4分别为区域1和骨干区域生成Summary-LSA：
  - 对于骨干区域，RT4分别为网络N1-N4生成Summary-LSA 
  - 对于区域1，RT4分别为网络N6-N8和ASBR RT5、RT7生成Summary-LSA
  - 还将la和lb的主机路径汇总进一个Summary-LSA
  - 最后将网络N9-N11和主机H1的路径在进一个Summary-LSA中宣告，汇总过程是由RT11来生成的

### AS-external-LSA报头字段与生成
- 网络掩码：表示所宣告目标的IP地址掩码
- E位：外部路径类型：
  - 1：为类型2外部路径，cost值仅为外部cost值
  - 0：为类型1外部路径，cost值=内部cost值+外部cost值
- 距离值：路径的距离
- 转发地址：到达所宣告目标的流量应该被转发的地址，如果转发地址被设为0.0.0.0，数据就应当被转发到该ASBR
- 外部路径标识：附加在每条外部路径上的32位数，并不被OSPF协议自身所使用，而是被用于ASBR之间的通讯
- 可能包括附加的TOS信息，用于和以前版本的OSPF兼容
- ASBR生成，描述到达AS外部目标的路径，在整个AS中(除了存根区域)洪泛
- 示例：RT5分别为网络N12-N14生成三个AS-external-LSA，RT7分别为网络N12和N15生成两个AS-external-LSA
- - -

## LSR、LSU和LSAck包

### LSR包
- 在与邻居交换了DD包后，路由器发现它的一部分连接状态数据库已经过期，这时就使用LSR包来取得邻居数据库中较新的部分
- 所请求的LSA由LS类型、LS标识和宣告路由器来说明
- 发送：
  - 当在Exchange或Loading邻居状态时，连接状态请求列表中包含了需要从邻居更新的LSA列表
  - 路由器将连接状态请求列表包含在LSR包中发给邻居来取得这些LSA，直到请求列表为空
  - 当邻居状态为Loading而连接状态请求列表为空时，生成LoadingDone邻居事件将邻居状态转为Full
- 接收：
  - 当邻居状态为Exchange、Loading或Full时，应当接收LSR包，而在其他状态下应当忽略
  - 应当在路由器的数据库中检索LSR包中的每个LSA，并将其复制到LSU包中发往邻居
  - 如果某个LSA没有在数据库中被找到，说明在数据库交换过程中出错，应当生成BadLSReq邻居事件

### LSU包
- LSU包提供了洪泛LSA的机制，每个LSU包将其包含的LSA洪泛到距其起源更远的一跳
- LSU包在支持多播/广播的物理网络上使用多播
- 为了使洪泛过程可靠，洪泛的LSA由LSAck包所确认
- 如果需要重传当前的LSA，重传的LSA始终被直接发送到邻居
- LSU包中的LSA数量字段说明该更新包中包含的LSA数量

### 判定较新的LSA
- 当路由器遇到一个LSA的两个实例时，它必须判定哪一个较新
- LSA是通过LS类型、LS标识和宣告路由器来识别的
- 同一LSA的两个实例是通过LS序号、LS时限和LS校验和来判断哪个较新：
  - 较大LS序号的LSA较新，如果两个实例的序号相同：
    - 具有较大校验和的实例较新，两个实例的校验和也相同：
      - 如果其中一个实例的LS时限为MaxAge，则这个实例为较新
      - 如果两个实例LS时限的差异大于MaxAgeDiff，较小时限的实例为较新
  - 否则，两个实例被认为相同
  
### 将新LSA加入数据库
- 不论是因为洪泛的结果或是自生成了新的LSA，将新的LSA加入数据库将导致重新计算OSPF路由表：
  - Router-LSA和Network-LSA：必须从每个区域的最短路径树开始，重新计算整个路由表(而不仅仅是改变了连接状态数据库的区域)
  - Summary-LSA：必须重新计算由Summary-LSA所说明的路径，如果目标为ASBR，还必须检查所有的AS-external-LSA
  - AS-external-LSA：必须重新计算由AS-external-LSA所说明的路径
  - 同时，在加入新的LSA时，必须从数据库中删除旧的LSA，旧的实例必须同时从所有邻居的连接状态重传列表中删除

### 洪泛
- 在处理洪泛之前，要对所接收到的包进行很多一致性检查
- 当接收到较新的LSA后，必须将其向路由器的一些接口洪泛出去，并将LSA加到邻居的连接状态重传列表上，并维护邻居的连接状态请求列表
- 根据LSA的LS类型，LSA可以被洪泛到特定的接口上(合格接口)：
  - AS-external-LSA：除了存根区域，AS-external-LSA将被洪泛到整个AS中，合格接口就是除了虚拟通道和接入存根区域的所有其他路由器接口
  - 所有其他LS类型：所有其他的类型都和一个区域相关，合格接口就是接入该区域的所有接口；如果区域为骨干区域，也包括所有的虚拟通道
- 在广播网络上，LSU包是多播，LSU包的目标地址取决于接口状态：
  - 如果接口状态是DR或BDR，使用地址AllSPFRouters
  - 否则，使用地址AllDRouters
- 在非广播网络上，各个LSU包按单播分别发送到各个邻接的邻居，包的目标地址为邻居的IP地址

### LSAck包
- 通过明确的确认，使洪泛LSA变为可靠
- 根据当前发送接口的状态以及LSU包的发送路由器，LSAck包可能发送到多播地址AllSPFRouters或AllDRouters或者使用单播
- 包中包含了LSA头部的列表，标明LSA及其实例
- 有两种发送LSAck包的方法：
  - 延迟并按间隔时间发送：将多个确认装入一个LSAck包中时，使用一个LSAck包来一次向多个邻居表明确认时，以及当多个路由器接入同一网络使LSAck包的发送时间随机化时
  - 直接发送到特定邻居：收到重复的LSA时

### LSA老化
- 每个LSA都有LS时限域
- 当LSA被保存在路由器的数据库中时，LS时限被不断增加；同样，当LSU包被洪泛出特定接口时，LSA的LS时限也被增加InfTransDelay
- LSA的LS时限决不超过MaxAge，具有MaxAge的LSA不被用于路由表计算
- 当同时满足下两个条件时，达到MaxAge的LSA必须立即从路由器的LSDB中删除：
  - 不存在任何邻居连接状态重传列表
  - 没有邻居处于Exchange或Loading状态
- 提前老化LSA：不改变LS序号而将LS时限设为MaxAge，并重新洪泛，可以将LSA从路由域中废止
- - -

## 路由表

### 路由表结构
- 目标类型：目标类型为"网络"或"路由器"，在转发IP数据时仅使用网络项，路由器项仅用于建立路由表的中间步骤：
  - 路由器项记录了ABR和ASBR
  - ABR的路由表项用于计算区域间路径，并维持虚拟通道的配置
  - ASBR的路由表项用于计算AS外部路径
- 目标标识：目标的标识或名称，取决于目标类型：
  - 对网络项，标识是所关联的IP地址
  - 对路由器项，标识是OSPF的路由器标识
- 地址掩码：仅为网络项定义，网络的IP地址与地址掩码一起定义了IP地址的范围
- 可选项：当目标为路由器时，该项表示目标路由器所支持的OSPF可选项
- 区域：表示路由表是从哪个区域的连接状态信息中取得该路由表项
- 路由表项的其他部分描述了到达目标的一系列路径，下面的各域作为一个整体描述了一条路径：
  - 路径类型：有四种到达目标的路径类型，按优先选择的次序分别是：区域内路径、区域间路径、类型1外部路径和类型2外部路径
  - 距离值：到达目标的连接状态距离值
  - 类型2距离值：仅对类型2外部路径有效，在这些路径中该域表示路径中AS外部网络部分的距离
  - 连接状态起源：仅对区域内路径有效，该域标明了直接涉及目标的LSA
  - 当有相同路径类型和距离值的多条路径到达同一目标时(等值路径)被存储在一个路由表项中，每条等值路径由下面的域区分：
    - 下一跳：当向目标转发流量时，所使用的路由器输出接口
    - 宣告路由器：仅对区域间路径和AS外部路径有效，该域包含了宣告Summary-LSA或AS-external-LSA的路由器标识

### 查找路由表
- 插入"丢弃"路由表项：在开始查找前，用于路由器的活跃区域地址范围的"丢弃"路由表项应该插入到路由表中，"丢弃"项是使区域边界的汇总不产生环路而必须的
- 最长前缀匹配：也许会有多个路由表项与目标地址匹配，这时，最精确(最长)的匹配提供了"最佳"匹配的路由表项
- 如果没有相匹配的路由表项，或者最匹配的是"丢弃"项，那么该包的IP目标就被认为不可到达：该包不被转发，而是被丢弃并应当向包的源地址发出ICMP目标不可达信息
---

## 计算路由表

### 步骤
- 1.当前的路由表为无效，重新建立路由表，保存旧的路由表以发现路由表项的改变
- 2.计算区域内路径：通过为所接入的每个区域建立最短路径树来计算区域内路径，特别的所有目标类型为ABR的路由表项也在此步计算
- 3.计算区域间路径：通过查看Summary-LSA计算区域间路径，如果路由器接入多个区域，仅查看骨干区域的Summary-LSA
- 4.优化路径：如果ABR接入一个或多个传输区域，查看传输区域的Summary-LSA，是否有使用传输区域的路径比上面步骤2-3找到的路径好
- 5.计算到达外部目标的路径：通过查看AS-external-LSA计算到达外部目标的路径，ASBR的位置在上面步骤2-4中计算

### 计算最短路径：Dijkstra算法
- 路由器以自己为树根构建最短路径树，分为两步：
  - 首先仅考虑路由器和传输网络之间的连接，通过Dijkstra算法根据LSDB的子集形成树
  - 随后考虑存根网络连接，作为叶子加入树
- 通过计算最短路径，为每个传输节点建立下面的关联数据：
  - 节点标识：32位数，唯一的识别出节点：“
    - 对于路由器节点，节点标识就是OSPF路由器标识
    - 对于网络节点，就是网络上DR的IP地址
  - 一个LSA：每一个传输节点都有相关联的LSA：
    - 对于路由器节点就是Router-LSA
    - 对于传输网络，就是Network-LSA(由网络上的DR生成)，这时LSA的LS标识始终等于上面的节点标识
  - 下一跳列表：从树根到该节点最短路径的下一跳列表，每个下一跳都标记出转发流量的路由器输出接口
  - 从树根的距离：从树根到节点最短路径的连接状态距离

### 计算下一跳
- 如果在目标与树根之间的当前最短路径上有不止一个中间路由器，目标就简单的从父节点继承下一跳
- 否则，有两种情况：
  - 父节点为树根：这意味着目标是一个直接连接的网络或路由器，输出接口就是连接目标网络/路由器的OSPF接口
  - 父节点是一个连接计算路由器与目标的网络：下一跳列表通过检查目标的Router-LSA来决定

### 计算区域间路径
- 通过检查Summary-LSA可以计算区域间路径，如果路由器接入了多个区域，则仅检查骨干区域的Summary-LSA
- 对于每个Summary-LSA，其描述了通过传输区域A达到网络N的路径，假设该Summary-LSA是由被称为BR的ABR所生成：
  - 如果该LSA的距离为LSInfinity，或其LS时限等于MaxAge，检查下一个LSA
  - 如果该LSA是由计算路由器自己生成的，检查下一个LSA
  - 查找目标N的路由表项(如果N是ASBR，查找该"路由器"相关于骨干区域的路由表项)：
    - 如果没有针对BR的项，或路径类型不是区域内或区域间，或关联区域不是骨干区域，检查下一个LSA
  - 查找宣告路由器BR相关于区域A的路由表项：
    - 如果不存在BR的项，即区域A内不能到达BR，不对该LSA操作，并考虑下一个LSA
    - 否则，该LSA就描述了到达目标N的区域间路径，其距离值为到达BR的距离+LSA中说明的距离之和(IAC)
  - 如果IAC比当前N路由表中的距离要小，使用BR的下一跳列表来覆盖N的，并设定N的路由表距离为IAC

### 计算AS外部路径
- 通过检查AS-external-LSA可以计算AS外部路径
- 对于每个AS-external-LSA：
  - 如果该LSA的距离为LSInfinity，或其LS时限等于MaxAge，检查下一个LSA
  - 如果该LSA是由计算路由器自己生成的，检查下一个LSA
  - 称LSA描述的目标为N，在N的路由表中查找生成该LSA的ASBR：
    - 如果没有到达该ASBR的路径，即ASBR不可达，不作关于该LSA的操作，并考虑列表中的下一项
    - 否则，该LSA就描述了到达AS外部目标N的路径
  - 设定X为到达ASBR/转发地址首选路径的距离值，而Y为LSA中说明的距离值，X被称为连接状态距离，而Y为类型1或2的外部距离
  - 查找到达目标N的路由表项：
    - 如果没有，就加入到达N的AS外部路径，并设定下一跳为转发地址的下一跳列表，宣告路由器为ASBR
    - 如果外部路径的类型为1，则路径类型为类型1外部路径，距离等于X+Y
    - 如果外部路径的类型为2，则路径类型为类型2外部路径，连接状态中的路由器距离为X，类型2距离为Y
  - 将该LSA描述的外部路径与路由表中已经存在的到达N的路径按如下比较：
    - 如果新的路径更好，将当前路径替换到N的路由表项中
    - 如果新旧路径一样好，将新路径加到N路由表项的路径列表中
- - -

## 图例

### RT4的路由表
   类型   目标        区域   路径类型      距离值 下一跳    宣告路由器
   __________________________________________________________________
   N      N1          1      区域内        4      RT1       *
   N      N2          1      区域内        4      RT2       *
   N      N3          1      区域内        1      *         *
   N      N4          1      区域内        3      RT3       *
   R      RT3         1      区域内        1      *         *
   __________________________________________________________________
   N      Ib          0      区域内        22     RT5       *
   N      Ia          0      区域内        27     RT5       *
   R      RT3         0      区域内        21     RT5       *
   R      RT5         0      区域内        8      *         *
   R      RT7         0      区域内        14     RT5       *
   R      RT10        0      区域内        22     RT5       *
   R      RT11        0      区域内        25     RT5       *
   __________________________________________________________________
   N      N6          0      区域间        15     RT5       RT7
   N      N7          0      区域间        19     RT5       RT7
   N      N8          0      区域间        18     RT5       RT7
   N      N9-N11,H1   0      区域间        36     RT5       RT11
   __________________________________________________________________
   N      N12         *      类型 1 外部   16     RT5       RT5,RT7
   N      N13         *      类型 1 外部   16     RT5       RT5
   N      N14         *      类型 1 外部   16     RT5       RT5
   N      N15         *      类型 1 外部   23     RT5       RT7
   - - -
